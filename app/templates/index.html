<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YouTube Downloader - Enhanced</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    :root {
      --bg: #071022;
      --panel: #071427;
      --card: rgba(11, 18, 32, 0.95);
      --toast: rgba(7, 18, 39, 0.95);
      --accent: #ef4444;
      --accent-soft: rgba(239, 68, 68, 0.2);
      --success: #10b981;
      --muted: #9aa4b2;
      --text: #e6eef6;
      --border: rgba(255, 255, 255, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      height: 100%;
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    .wrap {
      max-width: 520px;
      margin: 16px auto;
      padding: 16px;
    }

    .panel {
      background: var(--panel);
      padding: 16px;
      border-radius: 16px;
    }

    h1 {
      margin: 0 0 12px;
      font-size: 1.5rem;
    }

    h3 {
      margin: 0 0 8px;
      font-size: 1.05rem;
      word-break: break-word;
    }

    .muted {
      color: var(--muted);
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    input[type=text] {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: inherit;
      font-size: 1rem;
      outline: none;
    }

    input[type=text]:focus {
      border-color: var(--accent);
    }

    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform .1s ease, opacity .15s ease;
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.08);
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    button:hover {
      opacity: .9;
    }

    button:active {
      transform: scale(.97);
    }

    .actions-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }

    .chk {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .9rem;
      color: var(--muted);
      cursor: pointer;
      user-select: none;
    }

    #formatsPanel {
      margin-top: 12px;
    }

    #formatsList {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 4px;
    }

    #formatsList::-webkit-scrollbar {
      width: 6px;
    }

    #formatsList::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, .2);
      border-radius: 3px;
    }

    .fmt-row {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 12px;
      border-radius: 14px;
      background: var(--card);
      border: 2px solid transparent;
      cursor: pointer;
      transition: .15s ease;
    }

    .fmt-row input {
      pointer-events: none;
    }

    .fmt-row.selected {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .fmt-row:active {
      transform: scale(.98);
    }

    .fmt-meta {
      flex: 1;
      font-size: .88rem;
      line-height: 1.35;
      word-break: break-word;
    }

    #downloadList {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
      min-height: 40px;
    }

    .dl-row {
      background: var(--card);
      padding: 10px 12px;
      border-radius: 12px;
    }

    .dl-title {
      font-weight: 700;
      font-size: .92rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dl-status {
      margin-top: 4px;
      font-size: .82rem;
      color: var(--muted);
    }

    a.dl-link {
      color: #7dd3fc;
      font-weight: 700;
      text-decoration: none;
    }

    .toast {
      position: fixed;
      top: 16px;
      right: 16px;
      background: var(--toast);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: .9rem;
      z-index: 9999;
      opacity: .96;
    }

    @media(min-width:640px) {
      .wrap {
        max-width: 720px;
      }

      h1 {
        font-size: 1.75rem;
      }

      .input-row {
        flex-direction: row;
      }

      .input-row input {
        flex: 1;
      }

      .actions-row {
        flex-direction: row;
        align-items: center;
      }
    }

    @media(min-width:1024px) {
      .wrap {
        max-width: 960px;
        padding: 24px;
      }

      #formatsPanel {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 360px;
        gap: 16px;
        align-items: start;
      }

      #downloadList {
        margin-top: 0;
        border-top: none;
        padding-top: 0;
        background: rgba(255, 255, 255, .03);
        padding: 12px;
        border-radius: 14px;
      }
    }

    @media(min-width:1280px) {
      .wrap {
        max-width: 1200px;
      }

      #formatsPanel {
        grid-template-columns: minmax(0, 1fr) 420px;
      }
    }
  </style>
</head>

<body>

  <div class="wrap">
    <div class="panel">
      <h1>YouTube Downloader</h1>

      <div class="input-row">
        <input id="url" type="text" placeholder="Paste YouTube URL" aria-label="YouTube URL">
      </div>

      <div class="actions-row">
        <button id="downloadBtn">⬇ Download</button>
        <button id="inspectBtn" class="secondary">Inspect</button>
        <label class="chk"><input type="checkbox" id="audioOnly"> Audio only</label>
      </div>

      <div id="formatsPanel">
        <div id="downloadList" aria-live="polite"></div>
        <div>
          <h3 id="videoTitle"></h3>
          <div id="formatsList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let socket = null;
    let downloads = {};
    let myKeys = new Set();
    let selectedFormat = null;
    let idleTimer = null;

    // Show toast notifications
    function toast(msg, err = false) {
      if (!msg) return;
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      if (err) t.style.background = '#8b1c1c';
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3200);
    }

    // Reset idle timer to auto-disconnect socket
    function resetIdle() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        if (socket) {
          socket.disconnect();
          socket = null;
          toast('Disconnected (idle)', true);
        }
      }, 300000); // 5 minutes
    }

    // Initialize Socket.IO connection and listeners
    function initSocket() {
      if (socket) return;

      socket = io({ timeout: 5000, reconnectionAttempts: 3 });

      ['mousemove', 'keydown', 'touchstart', 'scroll'].forEach(evt =>
        window.addEventListener(evt, resetIdle, true)
      );

      socket.on('connect', resetIdle);
      socket.on('connect_error', () => toast('Socket error', true));

      socket.on('download_started', data => {
        if (!data?.key) return;
        myKeys.add(data.key);
        setStatus(data.key, data.message || 'Queued');
      });

      socket.on('download_status', data => {
        if (!data || !myKeys.has(data.key)) return;
        setStatus(data.key, data.message || 'Processing…');
        if (data.title) setTitle(data.key, data.title);
      });

      socket.on('download_complete', data => {
        if (!data || !myKeys.has(data.key)) return;

        if (data.status === 'done' && data.download_url) {
          const url = data.download_url;
          const name = decodeURIComponent(url.split('/').pop());
          setStatus(data.key, `<a class="dl-link" href="${url}" download="${name}">⬇ Download</a>`);
          toast('Ready');
        } else {
          setStatus(data.key, `Error: ${data.message || 'failed'}`);
          toast(data.message || 'Download failed', true);
        }

        myKeys.delete(data.key);
      });
    }

    // Create a new row in the download list
    function createRow(key, title) {
      if (downloads[key]) return;

      const row = document.createElement('div');
      row.id = `dl-${key}`;
      row.className = 'dl-row';
      row.innerHTML = `
    <div class="dl-title">${title || 'Download'}</div>
    <div class="dl-status">Queued</div>
  `;
      document.getElementById('downloadList').appendChild(row);
      downloads[key] = row;
    }

    // Update the status of a download row
    function setStatus(key, html) {
      const el = downloads[key]?.querySelector('.dl-status');
      if (el) el.innerHTML = html;
    }
    function setTitle(key, html) {
      const el = downloads[key]?.querySelector('.dl-title');
      if (el) el.innerHTML = html;
    }

    // DOM Ready
    document.addEventListener('DOMContentLoaded', () => {
      const urlInput = document.getElementById('url');
      const inspectBtn = document.getElementById('inspectBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const formatsList = document.getElementById('formatsList');
      const audioOnly = document.getElementById('audioOnly');

      // Clear formats when URL changes
      urlInput.addEventListener('input', () => {
        formatsList.innerHTML = '';
        document.getElementById('videoTitle').textContent = '';
        selectedFormat = null;
      });

      // Inspect button click
      inspectBtn.onclick = async () => {
        const url = urlInput.value.trim();
        if (!url) return toast('URL required', true);

        inspectBtn.disabled = true;
        formatsList.innerHTML = '';
        selectedFormat = null;

        try {
          const res = await fetch('/inspect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });

          if (!res.ok) throw new Error('Inspect failed');

          const data = await res.json();
          document.getElementById('videoTitle').textContent = data.title || '';

          data.formats?.forEach(f => {
            const row = document.createElement('div');
            row.className = 'fmt-row';
            row.innerHTML = `
          <input type="radio">
          <div class="fmt-meta">
            <b>${f.format_id}</b> ${f.format_note || ''}
            <br>
            <span class="muted">
              ${f.vcodec !== 'none' ? f.vcodec : 'audio'} / ${f.acodec !== 'none' ? f.acodec : 'no audio'}
            </span>
          </div>
        `;
            row.onclick = () => {
              selectedFormat = f.format_id;
              formatsList.querySelectorAll('.fmt-row').forEach(r => r.classList.remove('selected'));
              row.classList.add('selected');
            };
            formatsList.appendChild(row);
          });

        } catch (e) {
          toast(e.message, true);
        } finally {
          inspectBtn.disabled = false;
        }
      };

      // Download button click
      downloadBtn.onclick = async () => {
        const url = urlInput.value.trim();
        if (!url) return toast('Paste URL first', true);
        if (!selectedFormat && audioOnly.checked) selectedFormat = "140";

        initSocket();
        downloadBtn.disabled = true;

        try {
          const res = await fetch('/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              url,
              format_id: selectedFormat,
              audio_only: audioOnly.checked ? 1 : 0
            })
          });

          if (!res.ok) throw new Error('Queue failed');

          const data = await res.json();
          if (data.key) createRow(data.key, data.title);
          toast('Download queued');

        } catch (e) {
          toast(e.message, true);
        } finally {
          downloadBtn.disabled = false;
        }
      };
    });
  </script>
</body>

</html>