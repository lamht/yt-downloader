<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Downloader</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    :root {
      --muted: #9aa4b2;
      --accent: #ef4444;
      --success: #10b981;
      --bg: #071022;
      --panel: #071427;
      --dl-bg: rgba(11, 18, 32, 0.95);
      --toast-bg: rgba(7, 18, 39, 0.95);
    }

    html,
    body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: #e6eef6;
    }

    .wrap {
      max-width: 1100px;
      margin: 28px auto;
      padding: 20px;
    }

    .panel {
      background: var(--panel);
      padding: 18px;
      border-radius: 12px;
    }

    .input-row {
      display: flex;
      gap: 10px;
    }

    .input-row input[type=text] {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      background: transparent;
      color: inherit;
    }

    .input-row button {
      padding: 10px 12px;
      border-radius: 8px;
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
      transition: 0.2s;
    }

    .input-row button:hover {
      opacity: 0.9;
    }

    #formatsList {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 360px;
      overflow: auto;
      margin-bottom: 12px;
    }

    .fmt-row {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), transparent);
      border: 1px solid rgba(255, 255, 255, 0.02);
      cursor: pointer;
      transition: 0.15s;
    }

    .fmt-row:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .fmt-meta {
      flex: 1;
    }

    .sticky-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--dl-bg);
      padding: 12px 20px;
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      z-index: 1100;
      flex-wrap: wrap;
    }

    .sticky-actions label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      margin-right: auto;
      cursor: pointer;
    }

    .sticky-actions button,
    .sticky-actions a#downloadLink {
      background: var(--accent);
      color: #fff;
      border-radius: 8px;
      padding: 10px 14px;
      border: none;
      cursor: pointer;
      transition: 0.2s;
      text-decoration: none;
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .sticky-actions button:hover,
    .sticky-actions a#downloadLink:hover {
      opacity: 0.9;
    }

    #downloadLink {
      display: none;
    }

    .toast {
      position: fixed;
      right: 18px;
      top: 18px;
      background: var(--toast-bg);
      color: #e6eef6;
      padding: 10px 14px;
      border-radius: 8px;
      z-index: 2000;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
      opacity: 0.95;
      transition: 0.3s;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel" style="margin-bottom:16px">
      <h1 style="margin:0 0 8px">YouTube Downloader</h1>
      <form id="inspectForm" method="POST" style="margin-bottom:8px">
        <input type="hidden" name="action" value="inspect" />
        <div class="input-row">
          <input type="text" name="url" placeholder="Paste YouTube URL" required />
          <button type="submit">Inspect</button>
        </div>
      </form>

      <div id="formatsPanel" class="panel" style="display:none">
        <h3 id="videoTitle"></h3>
        <div id="formatsList"></div>
      </div>
    </div>
  </div>

  <div class="sticky-actions" id="stickyBar" style="display:none">
    <label>
      <input type="checkbox" id="audioOnly" /> MP3 only
    </label>
    <button id="downloadBtn">⬇ Download Selected</button>
    <a id="downloadLink" href="#" target="_blank"></a>
  </div>

  <script>
    let socket = null;
    let currentUrl = null;
    let selectedFormat = null;
    let idleTimeout = null;

    function showToast(msg, err = false) {
      if (!msg) return;
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      if (err) t.style.background = '#8b1c1c';
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3500);
    }

    function resetIdleTimer() {
      if (idleTimeout) clearTimeout(idleTimeout);
      idleTimeout = setTimeout(() => {
        if (socket) {
          console.log('No activity for 5 minutes, disconnecting socket.');
          socket.disconnect();
          socket = null;
          showToast('Disconnected due to inactivity', true);
        }
      }, 300000); // 5 phút
    }

    function initSocket() {
      if (socket) return;
      socket = io({ timeout: 5000, reconnectionAttempts: 3 });

      ['mousemove', 'keydown', 'touchstart', 'scroll'].forEach(evt => {
        window.addEventListener(evt, resetIdleTimer, true);
      });

      socket.on('connect', () => resetIdleTimer());
      socket.on('connect_error', () => showToast('Socket connection failed', true));
      socket.on('disconnect', () => showToast('Socket disconnected', true));

      socket.on('download_complete', data => {
        if (!data || !data.download_url) return;

        const url = data.download_url;
        const fname = decodeURIComponent(url.split('/').pop());
        const downloadLink = document.getElementById('downloadLink');
        downloadLink.href = url;
        downloadLink.download = fname;
        downloadLink.textContent = '⬇ Download Ready';
        downloadLink.style.display = 'inline-block';

        // Click vào link ẩn luôn
        downloadLink.onclick = () => {
          downloadLink.style.display = 'none';
          downloadLink.href = '#';
          downloadLink.textContent = '';
        };

        showToast('Download Ready');
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const inspectForm = document.getElementById('inspectForm');
      const downloadBtn = document.getElementById('downloadBtn');
      const formatsPanel = document.getElementById('formatsPanel');
      const formatsList = document.getElementById('formatsList');
      const stickyBar = document.getElementById('stickyBar');
      const audioOnly = document.getElementById('audioOnly');
      const downloadLink = document.getElementById('downloadLink');

      inspectForm.addEventListener('submit', async e => {
        e.preventDefault();
        const url = inspectForm.url.value.trim();
        if (!url) return showToast('URL required', true);

        try {
          const res = await fetch('/inspect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Inspect failed');
          }

          const data = await res.json();
          if (!data.formats || data.formats.length === 0)
            throw new Error('No formats found');

          currentUrl = url;
          selectedFormat = null;
          formatsList.innerHTML = '';
          document.getElementById('videoTitle').textContent = data.title;

          data.formats.forEach(f => {
            const row = document.createElement('label');
            row.className = 'fmt-row';
            row.innerHTML = `
              <div style="width:36px"><input type="radio" name="format_id" value="${f.format_id}"></div>
              <div class="fmt-meta">
                <div style="font-weight:700">${f.format_id} <span class="muted">${f.format_note || ''}</span></div>
                <div class="muted">${f.vcodec !== "none" ? f.vcodec : 'audio'} / ${f.acodec !== "none" ? f.acodec : 'no audio'}</div>
              </div>
            `;
            row.onclick = () => selectedFormat = f.format_id;
            formatsList.appendChild(row);
          });

          formatsPanel.style.display = 'block';
          stickyBar.style.display = 'flex';
        } catch (err) {
          console.error(err);
          showToast(err.message, true);
        }
      });

      downloadBtn.addEventListener('click', async e => {
        if (!currentUrl || !selectedFormat) return showToast('Select format', true);
        initSocket();

        downloadBtn.disabled = true;
        try {
          const res = await fetch('/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              url: currentUrl,
              format_id: selectedFormat,
              audio_only: audioOnly.checked ? 1 : 0
            })
          });

          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Queue failed');
          }

          // Khi queue xong, link sẽ hiển thị khi event download_complete đến
          showToast('Download queued');
        } catch (err) {
          console.error(err);
          showToast(err.message, true);
        } finally {
          downloadBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>