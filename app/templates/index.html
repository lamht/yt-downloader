<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Downloader</title>

  <!-- socket.io -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    :root {
      --muted: #9aa4b2;
      --accent: #ef4444;
      --bg: #071022;
      --panel: #071427;
      --dl-bg: rgba(11, 18, 32, 0.95);
    }

    html, body {
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: #e6eef6;
    }

    .wrap { max-width: 1100px; margin: 28px auto; padding: 20px }
    .panel { background: var(--panel); padding: 18px; border-radius: 12px }

    .input-row { display: flex; gap: 10px }
    .input-row input {
      flex: 1; padding: 10px; border-radius: 8px;
      border: 1px solid rgba(255,255,255,.05);
      background: transparent; color: inherit;
    }
    .input-row button {
      padding: 10px 14px; border-radius: 8px;
      background: var(--accent); border: none;
      color: #fff; cursor: pointer;
    }

    .fmt-row {
      display: flex; gap: 12px; padding: 8px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.05);
      cursor: pointer;
    }
    .fmt-row:hover { background: rgba(255,255,255,.05) }

    .fmt-meta { flex: 1 }
    .muted { color: var(--muted); font-size: .9rem }

    .sticky {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--dl-bg); padding: 12px 20px;
      display: flex; gap: 12px; align-items: center;
    }

    #downloadList {
      position: fixed; left: 18px; bottom: 18px;
      display: flex; flex-direction: column; gap: 10px;
    }

    .dl-row {
      background: var(--dl-bg);
      padding: 10px; border-radius: 8px;
      min-width: 280px;
    }

    .dl-title { font-weight: 700; white-space: nowrap; overflow: hidden }
    .dl-status { color: var(--muted); margin-top: 6px }

    a { color: #7dd3fc; text-decoration: none }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel" style="margin-bottom:16px">
      <h1>YouTube Downloader</h1>
      <div class="input-row">
        <input id="urlInput" placeholder="Paste YouTube URL" />
        <button id="inspectBtn">Inspect</button>
      </div>
    </div>

    <div id="formatsPanel" class="panel" style="display:none">
      <h3 id="videoTitle"></h3>
      <div id="formatsList" style="display:flex;flex-direction:column;gap:8px"></div>
    </div>
  </div>

  <div id="downloadList"></div>

  <div id="stickyBar" class="sticky" style="display:none">
    <label class="muted">
      <input type="checkbox" id="audioOnly" /> Audio only
    </label>
    <button id="downloadBtn">⬇ Download</button>
  </div>

<script>
  let socket = null;
  let currentUrl = null;
  let selectedFormat = null;
  const activeKeys = new Set();

  /* ---------- socket ---------- */
  function initSocket() {
    if (socket) return;
    socket = io();

    socket.on("download_started", d => {
      activeKeys.add(d.key);
      addRow(d.key, d.title || "download");
      setStatus(d.key, "Queued");
    });

    socket.on("download_status", d => {
      if (!activeKeys.has(d.key)) return;
      setStatus(d.key, d.message || d.status);
    });

    socket.on("download_complete", d => {
      if (!activeKeys.has(d.key)) return;

      if (d.status === "done") {
        setStatus(d.key,
          `<a href="${d.download_url}">⬇ Download file</a>`
        );
      } else {
        setStatus(d.key, "Error");
      }

      activeKeys.delete(d.key);
      if (activeKeys.size === 0) {
        socket.disconnect();
        socket = null;
      }
    });
  }

  /* ---------- UI helpers ---------- */
  function addRow(key, title) {
    if (document.getElementById("dl-" + key)) return;
    const el = document.createElement("div");
    el.className = "dl-row";
    el.innerHTML = `
      <div class="dl-title">${title}</div>
      <div id="st-${key}" class="dl-status">...</div>
    `;
    el.id = "dl-" + key;
    document.getElementById("downloadList").appendChild(el);
  }

  function setStatus(key, html) {
    const el = document.getElementById("st-" + key);
    if (el) el.innerHTML = html;
  }

  /* ---------- inspect ---------- */
  document.getElementById("inspectBtn").onclick = async () => {
    const url = document.getElementById("urlInput").value.trim();
    if (!url) return alert("URL required");

    currentUrl = url;
    selectedFormat = null;

    const res = await fetch("/inspect", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url })
    });

    const data = await res.json();

    document.getElementById("videoTitle").textContent = data.title;
    const list = document.getElementById("formatsList");
    list.innerHTML = "";

    data.formats.forEach(f => {
      const row = document.createElement("div");
      row.className = "fmt-row";
      row.innerHTML = `
        <input type="radio" name="fmt">
        <div class="fmt-meta">
          <b>${f.format_id}</b>
          <div class="muted">
            ${f.vcodec !== "none" ? f.vcodec : "audio"} /
            ${f.acodec !== "none" ? f.acodec : "no audio"}
          </div>
        </div>
      `;
      row.onclick = () => selectedFormat = f.format_id;
      list.appendChild(row);
    });

    document.getElementById("formatsPanel").style.display = "block";
    document.getElementById("stickyBar").style.display = "flex";
  };

  /* ---------- download ---------- */
  document.getElementById("downloadBtn").onclick = async () => {
    if (!currentUrl || !selectedFormat) {
      return alert("Select format");
    }

    initSocket();

    const res = await fetch("/download", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        url: currentUrl,
        format_id: selectedFormat,
        audio_only: document.getElementById("audioOnly").checked ? 1 : 0
      })
    });

    const data = await res.json();
    if (data.key) activeKeys.add(data.key);
  };
</script>
</body>
</html>